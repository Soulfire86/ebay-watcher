function setCookie(e,t,o){var n=new Date;n.setTime(n.getTime()+24*(o||30)*60*60*1e3);var a="expires="+n.toUTCString();document.cookie=e+"="+t+"; "+a}function getCookie(e){for(var t=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(var a=o[n];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(t))return a.substring(t.length,a.length)}return""}var eBayWatcher=angular.module("eBayWatcher",[]);eBayWatcher.controller("AccountController",["$scope","$http","DataService",function(e,t,o){function n(){t.defaults.headers.common.eBayWatcherToken=getCookie("eBayWatcherToken"),t.defaults.headers.common.eBayWatcherUsername=getCookie("eBayWatcherUsername"),e.loginStep="LoggedIn"}e.loading=!0,e.loginStep="StartingSession",e.eBayLoginUrl="",e.getState=function(){e.loading=!0,getCookie("eBayWatcherSession")&&getCookie("eBayWatcherLoginUrl")?(e.loginStep="AwaitingLogin",e.eBayLoginUrl=getCookie("eBayWatcherLoginUrl"),getCookie("eBayWatcherToken")&&getCookie("eBayWatcherUsername")?(n(),e.loading=!1):e.confirmLogin()):e.startLogin()},e.startLogin=function(){t.post(o.baseUrl+"/Account").then(function(t){console.log("Got new session id "+t.data.SessionId),setCookie("eBayWatcherSession",t.data.SessionId),setCookie("eBayWatcherLoginUrl",t.data.LoginUrl),e.loginStep="AwaitingLogin",e.loading=!1,e.eBayLoginUrl=t.data.LoginUrl},function(t){e.loading=!1})},e.confirmLogin=function(){e.loading=!0,t.post(o.baseUrl+"/Account/ConfirmLogin",{sessionId:getCookie("eBayWatcherSession")}).then(function(t){console.log("Got token "+t.data.Token+" for user "+t.data.Username),setCookie("eBayWatcherToken",t.data.Token),setCookie("eBayWatcherUsername",t.data.Username),n(),e.loading=!1},function(t){e.loading=!1,e.eBayLoginUrl=getCookie("eBayWatcherLoginUrl")})},e.getStatusMessage=function(){return"AwaitingLogin"===e.loginStep?"Not logged in":"Logged in as "+getCookie("eBayWatcherUsername")},e.getState(),e.logOut=function(){setCookie("eBayWatcherSession",""),setCookie("eBayWatcherToken",""),setCookie("eBayWatcherLoginUrl",""),setCookie("eBayWatcherUsername",""),e.loginStep="StartingSession",e.getState()}}]),eBayWatcher.controller("CategorySearchController",["$scope","$http","$rootScope","DataService",function(e,t,o,n){e.searchTerm="",e.selectedCategory={id:null,name:"[Please select category]"},e.visible=!1,e.results=[],e.loading=!1,o.$on("category:open",function(){console.log("Opening select category window..."),e.visible=!0,document.getElementById("categorySearchBox").focus()}),e.backdropClicked=function(){e.visible=!1},e.contentClicked=function(e){e.stopPropagation()},e.search=function(){e.loading=!0,t.post(n.baseUrl+"/Categories/Search",{searchTerm:e.searchTerm,eBayToken:getCookie("eBayWatcherToken")}).then(function(t){e.results=t.data,e.loading=!1,e.searched=!0},function(t){alert("error sending request"),e.loading=!1})},e.selectItem=function(t){o.$broadcast("category:selected",t),e.visible=!1}}]),eBayWatcher.controller("MyListController",["$scope","$http","$rootScope","DataService",function(e,t,o,n){e.loading=!1,e.newItem={},e.list=[],e.newItem.CategoryId=260,e.newItem.CategoryName="Stamps",e.selectCategory=function(){o.$broadcast("category:open")},o.$on("category:selected",function(t,o){console.log("received category selected"),console.log(o),e.newItem.CategoryId=o.Id,e.newItem.CategoryName=o.Name}),e.itemSelected=function(t){console.log("item selected"),console.log(t),o.$broadcast("item:selected",t),$.each(e.list,function(e,t){t.Selected=!1}),t.Selected=!0},e.addItem=function(o){if(!o.Name||o.Name.length<3)return void alert("Search text must be at least 3 characters long.");console.log("item added to list"),console.log(o);var a={Name:o.Name,SearchText:o.SearchText||o.Name,CategoryId:o.CategoryId,CategoryName:o.CategoryName};e.saving=!0,t.post(n.baseUrl+"/WatchListItems",{Username:getCookie("eBayWatcherUsername"),Token:getCookie("eBayWatcherToken"),item:a}).then(function(t){var o=t.data;e.saving=!1,e.list.push(o)},function(t){e.saving=!1})},e.refresh=function(){t.get(n.baseUrl+"/WatchListItems").then(function(t){e.list=t.data},function(e){})},e.refresh(),o.$on("list:refresh",function(t){e.refresh()})}]),eBayWatcher.controller("SearchController",["$scope","$http","$rootScope","DataService",function(e,t,o,n){e.loading=!0,e.searched=!1,e.wishlistItem=null,o.$on("item:search",function(t,o){e.wishlistItem=o,e.search(o.SearchText,o.CategoryId)}),e.search=function(o,a){e.loading=!0,t.post(n.baseUrl+"/EbaySearch",{searchTerm:o,categoryId:a}).then(function(t){e.results=t.data,e.loading=!1,e.searched=!0},function(t){e.loading=!1})},e.ignore=function(t){t.Ignore=!0,n.ignore(e.wishlistItem,t)},e.pin=function(t){t.Pin=!0,n.pin(e.wishlistItem,t)},e.unpin=function(t){t.Pin=!1,n.unpin(e.wishlistItem,t)}}]),eBayWatcher.controller("UpdateItemController",["$scope","$http","$rootScope","DataService",function(e,t,o,n){e.saving=!1,e.item=null,o.$on("item:selected",function(t,o){console.log("Received item selected message."),console.log(o),e.item=o,n.setItem(o)}),e["delete"]=function(a){e.saving=!0,t["delete"](n.baseUrl+"/WatchListItems/"+a.Id).then(function(t){o.$broadcast("list:refresh"),e.saving=!1,e.item=null},function(t){e.saving=!1})},e.search=function(e){o.$broadcast("item:search",e)}}]),eBayWatcher.factory("DataService",["$http","$rootScope",function(e,t){var o={baseUrl:"https://ebaywatcherwebapi.azurewebsites.net",notifyAllOfItemUpdated:function(e){t.$broadcast("item:updated",e)}};return o.setItem=function(e){this.currentListItem=e},o.ignore=function(e,t){console.log("ignoring"),console.log(e),console.log(t)},o.pin=function(e,t){console.log("pinning"),console.log(e),console.log(t)},o.unpin=function(e,t){console.log("unpinning"),console.log(e),console.log(t)},o}]);